# 防火墙系列`CLI`命令使用说明

## v-add-firewall-ban

* [命令行Bash 脚本查看](https://hestiamb.org/bin/v-add-firewall-ban)

`v-add-firewall-ban` 是一个 Bash 脚本命令，用于向防火墙添加阻塞规则。从提供的脚本内容来看，该命令的主要功能是将指定的 IP 地址添加到防火墙的阻塞列表中，并将其分配到特定的链（chain）中。以下是关于 `v-add-firewall-ban` 命令的详细解释：

### 命令格式

通常，该命令的使用格式如下：

```bash
v-add-firewall-ban `IP` `CHAIN`
```

其中：

- `<IP>` 是你想要阻塞的 IP 地址。
- `<CHAIN>` 是你想要将这个 IP 地址分配到的防火墙链的名称。

### 脚本功能详解

1. **参数处理**：
   - 脚本首先获取传递给它的两个参数：`$1` 是 IP 地址，`$2` 是链名。链名会被转换为大写。

2. **环境准备**：
   - 脚本加载了必要的配置文件和函数库，这些文件和库包含了执行后续操作所需的配置和函数。

3. **参数和状态检查**：
   - 脚本检查是否提供了正确数量的参数。
   - 验证 IP 地址和链名的格式是否有效。
   - 检查防火墙系统是否启用。
   - 检查是否处于演示模式（如果有的话）。
   - 修复 iptables 链接（如果有必要）。

4. **检查是否已存在**：
   - 脚本检查指定的 IP 地址是否已经在阻塞列表中或是否是本地回环地址（`127.0.0.1`），如果是，则直接退出。
   - 检查 IP 地址是否在被排除的列表中，如果在，则也直接退出。

5. **添加防火墙链和规则**：
   - 如果以上检查都通过，脚本会调用一个函数（`$BIN/v-add-firewall-chain`）来添加或确保所需的防火墙链存在。
   - 生成一个时间戳，并将 IP 地址、链名、时间戳添加到阻塞列表中。
   - 使用 `iptables` 命令向指定的链添加规则，以拒绝来自该 IP 地址的所有连接尝试，并使用 ICMP 端口不可达消息作为拒绝理由。

6. **日志和权限**：
   - 修改阻塞列表文件的权限，确保只有特定用户可以读写。
   - 记录一条日志，表示已经将指定的 IP 地址添加到防火墙阻塞列表中。

7. **退出**：
   - 完成所有操作后，脚本退出。

### 使用示例

假设你想要阻塞 IP 地址 `37.120.129.20`，并将其添加到名为 `MAIL` 的防火墙链中，你可以这样使用 `v-add-firewall-ban` 命令：

```bash
v-add-firewall-ban 37.120.129.20 MAIL
```

执行这条命令后，IP 地址 `37.120.129.20` 将会被添加到防火墙的 `MAIL` 链中，所有来自这个 IP 地址的连接尝试都将被拒绝，并且会在日志中留下记录。

---  

## `v-add-firewall-chain`

* [命令行Bash 脚本查看](https://hestiamb.org/bin/v-add-firewall-chain)

添加防火墙规则

**选项**: `CHAIN` `[PORT]` `[PROTOCOL]`

### CLI 命令 `v-add-firewall-chain` 解释

`v-add-firewall-chain` 是一个CLI（命令行界面）命令，它用于向Linux服务器的iptables防火墙添加新的链和规则。用于简化防火墙配置过程。

#### 命令用法

通常，`v-add-firewall-chain` 命令会接受以下参数：

- **链名称（CHAIN）**：指定要添加的iptables链的名称，例如SSH、FTP、WEB等。
- **端口号（PORT）**：可选参数，指定要保护的服务的端口号。如果未提供，脚本会使用默认端口。
- **协议（PROTOCOL）**：可选参数，指定要使用的网络协议，如TCP或UDP。如果未提供，脚本会使用默认协议。

#### 命令功能

1. **参数验证**：命令首先验证提供的参数是否有效和完整。

2. **默认设置**：如果未提供端口号或协议，命令会使用预定义的默认值。对于某些链（如SSH、FTP等），命令可能会查询系统配置或状态来确定正确的端口号。

3. **创建iptables链**：命令在iptables防火墙中创建一个新的链，链的名称通常与提供的参数相对应（例如`fail2ban-<chain>`）。

4. **添加iptables规则**：命令添加必要的iptables规则，以便将匹配特定端口和协议的流量重定向到新创建的链。这通常用于对这些流量进行进一步的过滤或处理。

5. **记录操作**：命令记录一条日志，指示已经添加了新的防火墙链和规则。这有助于管理员跟踪系统的状态和变化。

**使用方法**：

```bash
v-add-firewall-chain `CHAIN` [`PORT`] [`PROTOCOL`]
```

**示例**：

```bash
# 为SSH服务添加防火墙链，使用默认端口和协议
v-add-firewall-chain SSH

# 为SSH服务添加防火墙链，指定自定义端口和协议
v-add-firewall-chain SSH 2222 TCP
```

在这个例子中，`SSH` 是链的名称，`2222` 是SSH服务的端口号（假设你更改了默认的SSH端口），`TCP` 是网络协议。

---  

## `v-add-firewall-ipset`

* [命令行Bash 脚本查看](https://hestiamb.org/bin/v-add-firewall-ipset)

`v-add-firewall-ipset`是一个用于向Hestia控制面板的防火墙系统中添加或更新IP集的CLI命令。

### 用法

```bash
v-add-firewall-ipset <ip_name> <data_source> [<ip_version>] [<autoupdate>] [<refresh>]
```

### 参数

- **ip_name**：必需参数，用于标识和管理IP集的名称。
- **data_source**：IP集的数据源，可以是URL（http或https协议）、脚本（以`script:`开头）或本地文件（以`file:`开头）。如果未提供，脚本将尝试从Hestia的配置中查找默认的数据源。
- **ip_version**：可选参数，用于指定IP集的版本。默认为`v4`（IPv4），也可以指定为`v6`以使用IPv6地址。
- **autoupdate**：可选参数，指定是否自动更新IP列表。默认为`yes`。
- **refresh**：可选参数，指定是否强制刷新IP列表。默认为`no`。

### 功能描述

- 该命令首先验证提供的参数是否有效，包括检查IP集名称的格式，以及`autoupdate`和`refresh`是否为有效的布尔值。
- 接着，命令会检查防火墙系统是否启用，并确认是否处于Hestia的演示模式。
- 如果系统中没有安装`ipset`命令，脚本会尝试根据操作系统类型自动安装它。
- 脚本会确保用于存储IP集配置和数据的目录存在。
- 如果未提供数据源，脚本会尝试从Hestia的配置中查找与指定IP集名称关联的数据源。
- 脚本会验证提供的IP版本是否为`v4`或`v6`。
- 最后，脚本会验证数据源格式是否为有效的URL、脚本或文件路径。

### 示例

假设你想要添加一个名为`my_ipset`的IPv4 IP集，使用URL作为数据源，并启用自动更新，你可以使用以下命令：

```bash
v-add-firewall-ipset my_ipset 'http://example.com/ipset-data.txt' v4 yes
```

在这个例子中，`my_ipset`是IP集的名称，`http://example.com/ipset-data.txt`是数据源URL，`v4`指定使用IPv4地址，`yes`表示启用自动更新。

### 总结

`v-add-firewall-ipset`命令为Hestia控制面板的用户提供了一个方便的方式来添加或更新防火墙系统中的IP集。通过指定必要的参数，用户可以轻松管理IP集，并设置相应的自动更新和刷新选项。请确保在使用此命令时遵循最佳实践和注意事项，以确保系统的安全性和可靠性。

---  

## `v-add-firewall-rule`

* [命令行Bash 脚本查看](https://hestiamb.org/bin/v-add-firewall-rule)

`v-add-firewall-rule` 是一个用于向 Hestia 控制面板的防火墙系统添加规则的 CLI 命令。此命令允许管理员通过命令行界面快速、灵活地配置防火墙规则，以增强系统的安全性。

### 用法

```bash
v-add-firewall-rule <ACTION> <IP> <PORT_EXT> [PROTOCOL] [COMMENT] [RULE]
```

### 参数

- **ACTION**: 必填参数，指定防火墙规则的动作（如 ACCEPT, DROP 等）。
- **IP**: 必填参数，指定规则适用的 IP 地址或 IP 集名称（以 `ipset:` 开头）。
- **PORT_EXT**: 必填参数，指定规则适用的端口或端口范围。
- **PROTOCOL**: 可选参数，指定协议类型（如 TCP, UDP 等），默认为 TCP。
- **COMMENT**: 可选参数，为规则添加注释信息。
- **RULE**: 可选参数，指定规则的编号，如果不提供，则自动获取下一个可用的规则编号。

### 功能描述

- **检查参数数量与格式**：命令首先检查提供的参数数量是否满足要求，并对参数格式进行验证，确保输入的数据是有效的。
- **获取下一个规则编号**：如果未指定规则编号，命令将自动获取下一个可用的规则编号。
- **验证系统状态与配置**：命令检查防火墙系统是否启用，以及是否处于 Hestia 的演示模式。同时，还验证防火墙相关的配置是否正确。
- **检查 IP 集是否存在**：如果指定的 IP 是 IP 集名称，命令将检查该 IP 集是否存在。
- **添加防火墙规则**：在验证所有输入和状态后，命令将新的防火墙规则添加到 `rules.conf` 配置文件中。
- **更新防火墙**：添加规则后，命令会更新防火墙配置，使新规则立即生效。
- **记录日志**：命令将记录添加防火墙规则的操作到日志中，以便后续审计和追踪。

### 示例

```bash
# 添加一个允许 TCP 访问端口 80 的防火墙规则
v-add-firewall-rule ACCEPT 192.168.1.100 80 TCP "Allow HTTP traffic"

# 添加一个允许 UDP 访问端口范围 1000-2000 的防火墙规则，并指定规则编号
v-add-firewall-rule ACCEPT 192.168.1.200 1000-2000 UDP "Allow UDP traffic" 5

# 使用 IP 集添加防火墙规则
v-add-firewall-rule DROP ipset:my_ipset 22 TCP "Block SSH access for IP set"
```

```bash
v-add-firewall-rule DROP 185.137.111.77 25
```

---  

## `v-delete-sys-firewall`

* [命令行Bash 脚本查看](https://hestiamb.org/bin/v-delete-sys-firewall)

`v-delete-sys-firewall` 是一个用于删除或禁用系统防火墙的 CLI 命令。该命令允许管理员通过命令行界面轻松关闭或移除防火墙，以便在特定情况下进行维护、故障排除或其他操作。

### 使用方法

```bash
v-delete-sys-firewall
```

### 功能描述

该命令的主要功能是禁用系统防火墙支持。它执行以下操作：

1. 检查系统防火墙配置是否存在。
2. 停止防火墙服务。
3. 更新系统配置，以反映防火墙已被禁用。
4. 记录禁用防火墙的日志信息。

### 注意事项

- **安全性**：禁用系统防火墙可能会使系统暴露于潜在的安全风险中。在执行此命令之前，请确保了解潜在的安全影响，并采取适当的安全措施。
- **只读模式**：如果 Hestia 控制面板处于只读模式，该命令将不会执行任何操作。
- **依赖项**：该命令依赖于 Hestia 控制面板的配置和工具集，因此请确保已正确安装和配置了 Hestia。

### 示例

要禁用系统防火墙，只需运行以下命令：

```bash
v-delete-sys-firewall
```

执行命令后，系统将停止防火墙服务并更新配置，以反映防火墙已被禁用。同时，还会在日志中记录相关信息。

### 日志记录

该命令会记录一条警告级别的日志信息，指示系统防火墙已被禁用。这有助于管理员跟踪和监控防火墙的状态变化。

### 总结

`v-delete-sys-firewall` 是一个强大的 CLI 命令，用于禁用系统防火墙。在需要关闭防火墙以进行维护或故障排除时，该命令非常有用。然而，请务必谨慎使用，并确保在禁用防火墙之前了解潜在的安全风险。同时，建议定期监控和审查防火墙的日志信息，以确保系统的安全性得到维护。

---  

## `v-delete-firewall-rule`

* [命令行Bash 脚本查看](https://hestiamb.org/bin/v-delete-firewall-rule)

`v-delete-firewall-rule` 是一个用于删除指定防火墙规则的 CLI 命令。通过此命令，管理员可以方便地移除不再需要的防火墙规则，从而灵活调整网络访问策略。

### 使用方法

```bash
v-delete-firewall-rule [RULE]
```

- `[RULE]`：要删除的防火墙规则的标识符。

### 功能描述

该命令执行以下操作：

1. 验证输入的参数是否正确和有效。
2. 检查防火墙系统是否启用。
3. 验证要删除的防火墙规则是否存在。
4. 在只读模式下执行额外的验证。
5. 从防火墙配置文件中删除指定的规则。
6. 更新系统防火墙，应用新的配置。
7. 记录删除防火墙规则的日志信息。

### 注意事项

- **参数有效性**：请确保提供正确的防火墙规则标识符作为参数。
- **防火墙状态**：在执行此命令之前，请确保防火墙系统已经启用。
- **权限要求**：执行此命令需要相应的权限，否则可能无法成功删除防火墙规则。

### 示例

假设要删除名为 `SSH_BLOCK` 的防火墙规则，可以运行以下命令：

```bash
v-delete-firewall-rule SSH_BLOCK
```

执行命令后，系统将验证参数的有效性、防火墙系统的状态以及规则的存在性，然后从防火墙配置文件中删除该规则，并更新系统防火墙。最后，将记录一条日志信息，指示已删除指定的防火墙规则。

### 日志记录

该命令会记录一条信息级别的日志，指明已删除防火墙规则，并包含规则的标识符。这有助于管理员跟踪和监控防火墙规则的变化。

### 总结

`v-delete-firewall-rule` 是一个用于删除指定防火墙规则的 CLI 命令。它提供了灵活的网络访问策略调整功能，帮助管理员根据实际需求管理防火墙规则。在使用该命令时，请确保提供正确的参数，并注意防火墙系统的状态和权限要求。同时，建议定期查看防火墙的日志信息，以便及时了解防火墙规则的变化情况。

---  

## `v-delete-firewall-ipset`

* [命令行Bash 脚本查看](https://hestiamb.org/bin/v-delete-firewall-ipset)

### 简介

`v-delete-firewall-ipset` 是一个 Bash 脚本，用于删除防火墙中的 IP 集（IPset）。该脚本通常运行在安装了 HestiaCP（一种开源的Web托管控制面板）的系统上。它接受一个参数，即要删除的 IP 集的名称，并确保安全地删除该 IP 集及其相关配置。

### 使用方法

### 语法

```bash
v-delete-firewall-ipset NAME
```

### 参数

- `NAME`：要删除的 IP 集的名称。

### 示例

```bash
v-delete-firewall-ipset my_ipset
```

上面的命令会删除名为 `my_ipset` 的 IP 集。

### 脚本流程

1. **参数检查**：脚本首先检查是否提供了必要的参数（即 IP 集的名称）。

2. **环境配置**：加载 HestiaCP 的配置文件和函数库。

3. **验证 IP 集名称**：检查提供的 IP 集名称是否有效，以及防火墙系统是否启用。

4. **定义变量**：设置 IP 集配置相关的变量。

5. **检查 IPset 工具**：确认 `ipset` 命令是否已安装。如果没有安装，则根据系统类型（基于 Red Hat 或 Debian）自动安装。

6. **删除临时 IP 集**：如果存在与指定 IP 集名称相对应的临时 IP 集，则先删除它。

7. **删除 IP 集**：删除指定的 IP 集。如果 IP 集仍被 iptables 使用，脚本将记录错误并退出。

8. **更新配置文件**：从配置文件中删除与已删除 IP 集相关的条目。

9. **删除相关文件**：删除与 IP 集关联的 IP 列表文件。

10. **记录日志**：记录删除 IP 集的操作的信息日志。

11. **退出**：脚本执行完毕，退出。

### 注意事项

- 在执行此脚本之前，请确保您有足够的权限来修改防火墙配置。
- 请确保您提供的 IP 集名称是正确的，以避免意外删除错误的 IP 集。
- 在生产环境中运行此脚本之前，最好在测试环境中验证其功能。

### 错误处理

脚本中包含了多个错误检查点，用于处理各种可能发生的错误情况，例如 `ipset` 命令未安装、IP 集仍在使用中等。如果发生错误，脚本将记录错误信息并可能退出执行。

### 日志记录

脚本会记录关键操作的日志，以便于后续的故障排查和系统监控。

### 总结

`v-delete-firewall-ipset` 脚本提供了一个方便的方式来删除防火墙中的 IP 集，并确保了操作的安全性和可靠性。通过遵循上述使用方法和注意事项，您可以有效地管理您的防火墙 IP 集配置。

---  

### `v-delete-firewall-ban`

* [命令行Bash 脚本查看](https://hestiamb.org/bin/v-delete-firewall-ban)

### 简介

`v-delete-firewall-ban` 是一个 Bash 脚本，用于从防火墙的封禁列表中删除特定的 IP 地址及其相关的封禁规则。该脚本通常与 （ HestiaCP Web 托管控制面板）一起使用，并依赖于其提供的配置文件和函数库。

### 使用方法

### 语法

```bash
v-delete-firewall-ban IP CHAIN
```

### 参数

- `IP`：要删除的封禁 IP 地址。
- `CHAIN`：封禁链的名称，可以是具体的链名（如 `ssh`、`http` 等）或 `ALL` 表示所有链。

### 示例

```bash
v-delete-firewall-ban 192.168.1.100 ssh
```

上面的命令将从 `ssh` 链中删除 IP 地址 `192.168.1.100` 的封禁规则。

```bash
v-delete-firewall-ban 192.168.1.100 ALL
```

这个命令将从所有链中删除 IP 地址 `192.168.1.100` 的封禁规则。

### 脚本流程

1. **初始化**：脚本初始化变量，并加载 HestiaCP 的配置文件和函数库。

2. **参数检查**：验证是否提供了正确的参数数量（IP 地址和链名），并检查参数的格式是否有效。

3. **系统检查**：确认防火墙系统是否启用，并检查是否处于 HestiaCP 的演示模式。

4. **读取封禁列表**：从封禁配置文件 `banlist.conf` 中读取封禁信息。

5. **处理 ALL 链**：如果指定的链名为 `ALL`，则遍历配置文件，找到与指定 IP 地址相关的所有链，并删除相应的封禁规则和配置条目。

6. **处理具体链**：如果指定了具体的链名，则只删除该链中与指定 IP 地址相关的封禁规则和配置条目。

7. **更新文件权限**：更新封禁配置文件的权限，确保只有授权用户可以修改。

8. **记录日志**：记录删除封禁 IP 地址的操作的信息日志。

9. **退出**：脚本执行完毕，退出。

### 注意事项

- 在运行此脚本之前，请确保您有足够的权限来修改防火墙配置和封禁列表。
- 请确保提供正确的 IP 地址和链名，以避免误删其他 IP 地址的封禁规则。
- 在生产环境中运行此脚本之前，请在测试环境中验证其功能。

### 错误处理

脚本包含多个错误检查点，用于处理可能发生的错误情况，例如参数格式不正确、IP 地址或链名不存在等。如果发生错误，脚本将记录错误信息并可能退出执行。

### 日志记录

脚本会记录关键操作的日志，包括删除的 IP 地址、链名以及操作时间等信息，以便于后续的故障排查和系统监控。

### 总结

`v-delete-firewall-ban` 脚本提供了一个便捷的方式来管理防火墙的封禁列表，允许用户从特定的链或所有链中删除指定的 IP 地址及其封禁规则。通过遵循上述使用方法和注意事项，您可以有效地管理您的防火墙封禁策略。

---  

## `v-delete-firewall-chain` 

* [命令行Bash 脚本查看](https://hestiamb.org/bin/v-delete-firewall-chain)

### 简介

`v-delete-firewall-chain` 是一个 Bash 脚本，用于删除指定的防火墙链及其相关配置。该脚本通常与 HestiaCP（一种开源的 Web 托管控制面板）一起使用，并依赖于其提供的配置文件和函数库。

### 使用方法

### 语法

```bash
v-delete-firewall-chain CHAIN
```

### 参数

- `CHAIN`：要删除的防火墙链的名称。

### 示例

```bash
v-delete-firewall-chain ssh
```

上面的命令将删除名为 `ssh` 的防火墙链及其相关配置。

### 脚本流程

1. **初始化**：脚本初始化变量，并加载 HestiaCP 的配置文件和函数库。

2. **参数检查**：验证是否提供了正确的参数数量（链名），并检查参数的格式是否有效。

3. **系统检查**：确认防火墙系统是否启用，并检查是否处于 HestiaCP 的演示模式。

4. **读取链配置**：从链配置文件 `chains.conf` 中读取链的相关配置。

5. **删除链配置**：如果链存在，则删除链在 `chains.conf` 和封禁列表 `banlist.conf` 中的配置条目。

6. **删除链规则**：根据链的配置信息，删除链相关的 iptables 规则。

7. **删除 iptables 链**：清空链中的所有规则，并删除 iptables 中的链。

8. **更新文件权限**：更新链配置文件的权限，确保只有授权用户可以修改。

9. **记录日志**：记录删除防火墙链操作的信息日志。

10. **退出**：脚本执行完毕，退出。

### 注意事项

- 在运行此脚本之前，请确保您有足够的权限来修改防火墙配置和链的设置。
- 请谨慎使用此脚本，确保您提供正确的链名，以避免误删其他链的配置和规则。
- 在生产环境中运行此脚本之前，请在测试环境中验证其功能。

### 错误处理

脚本包含多个错误检查点，用于处理可能发生的错误情况，例如参数格式不正确、链不存在等。如果发生错误，脚本将记录错误信息并可能退出执行。

### 日志记录

脚本会记录删除防火墙链操作的关键信息日志，包括删除的链名以及操作时间等信息，以便于后续的故障排查和系统监控。

### 总结

`v-delete-firewall-chain` 脚本提供了一个便捷的方式来管理防火墙链，允许用户删除指定的链及其相关配置和规则。通过遵循上述使用方法和注意事项，您可以有效地管理您的防火墙链设置。

---  

## `v-change-firewall-rule` 

* [命令行Bash 脚本查看](https://hestiamb.org/bin/v-change-firewall-rule)

### 简介

`v-change-firewall-rule` 是一个 Bash 脚本，用于修改服务器的防火墙规则。它允许用户指定规则编号、动作、IP 地址、端口号、协议（可选）以及注释（可选），以更改或更新现有的防火墙规则。

### 使用方法

#### 语法

```bash
v-change-firewall-rule RULE ACTION IP PORT [PROTOCOL] [COMMENT]
```

#### 参数

- `RULE`: 要修改的防火墙规则的编号。
- `ACTION`: 防火墙规则的动作，如 `ACCEPT` 或 `DROP`。
- `IP`: 目标 IP 地址或 IP 集（ipset）的名称。
- `PORT`: 目标端口号。
- `PROTOCOL`: 协议类型（如 TCP 或 UDP），默认为 TCP。
- `COMMENT`: 可选的注释，用于描述规则。

#### 示例

```bash
v-change-firewall-rule 3 ACCEPT 5.188.123.17 443
```

上面的命令将修改编号为 3 的防火墙规则，使其接受来自 IP 地址 `5.188.123.17` 的 TCP 连接请求到端口 `443`。

### 脚本流程

1. **初始化**：脚本开始执行，加载必要的配置文件和函数库。

2. **参数处理**：从命令行参数中获取规则编号、动作、IP 地址、端口号、协议和注释，并进行格式转换和验证。

3. **检查参数数量**：验证提供的参数数量是否满足要求。

4. **验证格式**：使用 `is_format_valid` 函数检查规则编号、动作、协议、端口号和注释的格式是否有效。

5. **系统状态检查**：确保防火墙系统已启用，并检查是否处于演示模式。

6. **验证对象有效性**：使用 `is_object_valid` 函数验证规则编号是否对应一个有效的防火墙规则。

7. **IP 地址处理**：检查 IP 地址是否以 `ipset:` 开头，如果是，则验证 ipset 名称是否存在于列表中；否则，验证 IP 地址的格式是否有效。

8. **禁用 Hestia 演示模式**：检查是否处于 Hestia 演示模式，如果是，则禁用相关功能。

9. **生成规则字符串**：根据提供的参数，生成防火墙规则的字符串表示。

10. **更新规则文件**：使用 `sed` 命令从防火墙规则文件中删除旧的规则，并将新规则追加到文件末尾。

11. **排序规则**：调用 `sort_fw_rules` 函数对防火墙规则文件进行排序，确保规则按照正确的顺序执行。

12. **更新防火墙**：调用 `$BIN/v-update-firewall` 命令更新服务器的防火墙配置。

13. **记录日志**：记录防火墙规则更改的日志信息，包括规则编号、动作、协议和端口号。

14. **退出**：脚本执行完毕，返回操作结果并退出。

### 注意事项

- 在执行此命令之前，请确保您具有足够的权限来修改防火墙规则。
- 提供正确的参数，特别是规则编号和 IP 地址，以确保正确地修改目标规则。
- 如果提供的 IP 地址是一个 ipset 名称，请确保该 ipset 已经存在并包含正确的 IP 地址集合。
- 在生产环境中执行此命令之前，请先在测试环境中验证其功能，以避免意外的服务中断或安全风险。

### 日志记录

脚本在执行过程中会记录关键操作的信息日志，以便后续审查和分析。这有助于跟踪防火墙规则的变化历史以及诊断潜在问题。

### 总结

`v-change-firewall-rule` 命令是一个功能强大的工具，允许用户灵活地修改服务器的防火墙规则。通过遵循上述使用方法和注意事项，您可以安全有效地更新防火墙设置，以适应不同的安全需求和网络环境。

---  

## v-update-firewall

[命令行Bash 脚本查看](https://hestiamb.org/bin/v-update-firewall)

### 简介

在Hestia控制面板中，`v-update-firewall` 脚本用于更新服务器的防火墙规则。防火墙是网络安全的重要组成部分，用于控制进出服务器的网络流量。通过`v-update-firewall`脚本，管理员可以轻松地更新和管理防火墙规则，从而增强服务器的安全性。

### 使用方法

#### 1. 前提条件

- 确保你具有对Hestia控制面板服务器的root或具有足够权限的用户访问权限。
- 确保你的Hestia控制面板已正确安装并配置。

#### 2. 执行脚本

要运行`v-update-firewall`脚本，请按照以下步骤操作：

1. 打开终端或SSH会话，并连接到Hestia控制面板服务器。
2. 切换到具有足够权限的用户（通常是root用户）。
3. 输入以下命令来执行脚本：

```bash
sudo v-update-firewall
```

或者，如果你已经以root用户身份登录，只需输入：

```bash
v-update-firewall
```

#### 3. 脚本执行过程

脚本将执行以下步骤来更新防火墙规则：

1. **验证权限**：确保脚本以具有足够权限的用户身份运行。
2. **加载配置文件**：加载Hestia控制面板和防火墙相关的配置文件。
3. **检查防火墙服务**：验证防火墙服务是否正在运行，并准备进行更新。
4. **应用新的防火墙规则**：根据配置文件中的新规则，更新防火墙的当前规则集。
5. **验证更新**：验证防火墙规则已成功更新并处于活动状态。
6. **输出结果**：在终端中显示脚本执行的结果，包括任何错误或警告消息。

### 示例

#### 示例 1：成功更新防火墙

```bash
$ sudo v-update-firewall
Updating firewall rules...
Firewall service is running.
Applying new firewall rules...
Firewall rules updated successfully.
```

#### 示例 2：权限不足

```bash
$ v-update-firewall
ERROR: v-update-firewall can be run only by root user or a user with sudo privileges.
```

#### 示例 3：防火墙服务未运行

```bash
$ sudo v-update-firewall
Updating firewall rules...
Firewall service is not running. Starting firewall service...
Firewall service started.
Applying new firewall rules...
Firewall rules updated successfully.
```

#### 示例 4：更新过程中出现错误

```bash
$ sudo v-update-firewall
Updating firewall rules...
Firewall service is running.
Applying new firewall rules...
ERROR: Failed to apply firewall rule: 'some_specific_rule'.
Please check your firewall configuration and try again.
```

### 结论

`v-update-firewall`脚本是Hestia控制面板中用于更新防火墙规则的重要工具。通过正确使用该脚本，管理员可以轻松地管理和维护服务器的防火墙设置，从而提高服务器的安全性。在执行脚本时，请确保遵循上述步骤，并根据需要查看和处理任何错误或警告消息。

---

## v-update-firewall-ipset

* [命令行Bash 脚本查看](https://hestiamb.org/bin/v-update-firewall-ipset)

### 1. 概述

`v-update-firewall-ipset` 是一个用于更新防火墙IP集列表的命令行工具。通过运行该命令，您可以实现防火墙IP集的创建、加载及更新功能。这对于维护网络安全、过滤恶意流量以及保护系统安全至关重要。

### 2. 使用方法

在终端中直接执行 `v-update-firewall-ipset` 命令，以更新防火墙IP集列表。如果希望强制刷新IP集列表，可以在命令后面加上 `REFRESH` 参数，如 `v-update-firewall-ipset REFRESH`。

### 3. 脚本执行流程

以下是 `v-update-firewall-ipset` 脚本的主要执行流程：

1. **初始化**：加载必要的配置文件和函数库，包括Hestia CP的配置文件。

2. **参数验证**：检查是否提供了刷新参数，并进行有效性验证。

3. **系统状态检查**：验证防火墙系统是否已启用，以及系统是否处于只读模式（如演示模式）。

4. **遍历IP集**：遍历所有配置的IP集，并逐个处理。

5. **IP集信息获取**：获取每个IP集的更新时间、日期和自动更新设置。

6. **更新判断**：根据IP集的自动更新设置、上次更新时间以及是否提供了刷新参数，决定是仅加载现有IP集还是进行更新。

7. **IP集更新**：调用相关命令加载或更新IP集列表到内核中。

8. **日志记录**：记录事件日志，标记操作成功或失败。

9. **退出**：脚本执行完毕，退出程序。

### 4. 注意事项

- 在执行该命令之前，请确保已经正确配置了防火墙系统，并且所有必要的配置文件和模块都可用。
- 该命令可能需要root权限才能正确执行。
- 如果IP集文件不存在或格式不正确，脚本将跳过相应的IP集处理，并记录错误信息。

### 5. 调试与错误处理

- 如果在执行过程中遇到错误，请检查相关日志文件，获取详细的错误信息。
- 确保所有依赖的工具和模块都已正确安装和配置。
- 如果IP集更新不按预期工作，请检查配置文件中的IP集设置是否正确。

### 6. 结论

`v-update-firewall-ipset` 是一个功能强大的命令行工具，用于更新防火墙的IP集列表。通过正确使用该命令，您可以确保防火墙使用最新的IP集列表，从而有效地过滤网络流量、阻止恶意攻击，提高系统的安全性和稳定性。

### v-unsuspend-firewall-rule

* [命令行Bash 脚本查看](https://hestiamb.org/bin/v-unsuspend-firewall-rule)

### 一、概述

`v-unsuspend-firewall-rule` 是一个命令行工具，用于解除防火墙规则的暂停状态。当防火墙规则被暂停时，它将不再对流量进行过滤或阻止。通过执行 `v-unsuspend-firewall-rule` 命令，管理员可以恢复特定规则的活跃状态，从而恢复其对网络流量的控制。

### 二、使用方法

在终端中执行 `v-unsuspend-firewall-rule` 命令，并传递需要解除暂停状态的规则标识符作为参数。

#### 语法

```bash
v-unsuspend-firewall-rule <rule_identifier>
```

其中 `<rule_identifier>` 是要解除暂停状态的防火墙规则的标识符，通常是一个唯一的字符串或数字。

#### 示例

假设要解除暂停状态的规则标识符为 `rule123`，执行命令如下：

```bash
v-unsuspend-firewall-rule rule123
```

### 三、执行流程

以下是 `v-unsuspend-firewall-rule` 命令的主要执行流程：

1. **参数验证**：验证传递的规则标识符是否有效和存在。

2. **规则状态检查**：检查指定规则当前是否处于暂停状态。

3. **解除暂停**：如果规则处于暂停状态，执行解除暂停的操作。

4. **验证更新**：验证规则是否已成功解除暂停状态。

5. **日志记录**：记录规则解除暂停的操作和相关信息。

6. **退出**：命令执行完毕，退出程序。

### 四、注意事项

- 在执行 `v-unsuspend-firewall-rule` 命令之前，请确保您具备足够的权限和访问控制，以防止未经授权的更改。
- 请确保提供的规则标识符是正确且唯一的，以避免误操作其他规则。
- 解除暂停防火墙规则可能会导致网络流量的变化，请在操作前评估相关影响。

### 五、错误处理

- 如果规则标识符无效或不存在，命令将返回错误提示，并告知管理员无法找到相应的规则。
- 如果规则已经处于活跃状态（即未暂停），命令将返回相应的提示信息，告知管理员无需执行解除暂停操作。
- 如果在执行解除暂停操作时发生错误，命令将记录详细的错误信息，并显示在终端中，以便管理员进行排查和修复。

### 六、结论

`v-unsuspend-firewall-rule` 命令是一个用于解除防火墙规则暂停状态的实用工具。通过正确使用该命令，管理员可以灵活地控制防火墙规则的状态，确保网络流量得到正确的过滤和控制。请务必按照本文档中的说明进行操作，以避免潜在的问题和错误。

## v-suspend-firewall-rule

* [命令行Bash 脚本查看](https://hestiamb.org/bin/v-suspend-firewall-rule)

### 一、概述

`v-suspend-firewall-rule` 是一个命令行工具，用于暂停指定的防火墙规则。当防火墙规则被暂停时，它将不再对经过的流量进行过滤或执行预定的操作。这一功能在临时需要允许某些流量通过防火墙或者进行规则测试时非常有用。通过执行 `v-suspend-firewall-rule` 命令，管理员可以精确地控制哪些规则处于活跃状态，从而实现对网络流量的精细管理。

### 二、使用方法

在终端中执行 `v-suspend-firewall-rule` 命令，并指定需要暂停的防火墙规则的标识符作为参数。

#### 语法

```bash
v-suspend-firewall-rule <rule_identifier>
```

其中 `<rule_identifier>` 是要暂停的防火墙规则的标识符，通常是一个唯一的字符串或数字。

#### 示例

假设要暂停的规则标识符为 `rule456`，执行命令如下：

```bash
v-suspend-firewall-rule rule456
```

### 三、执行流程

以下是 `v-suspend-firewall-rule` 命令的主要执行流程：

1. **参数验证**：验证传递的规则标识符是否有效和存在。

2. **规则状态检查**：检查指定规则当前是否处于活跃状态。

3. **暂停规则**：如果规则处于活跃状态，执行暂停操作，将其标记为暂停状态。

4. **验证更新**：验证规则是否已成功暂停。

5. **日志记录**：记录规则暂停的操作和相关信息。

6. **退出**：命令执行完毕，退出程序。

### 四、注意事项

- 在执行 `v-suspend-firewall-rule` 命令之前，请确保您具备足够的权限和访问控制，以防止未经授权的更改。
- 请谨慎选择要暂停的规则，确保暂停操作不会对网络安全造成负面影响。
- 暂停防火墙规则可能会导致网络流量的变化，请在操作前评估相关影响，并通知相关利益相关者。

### 五、错误处理

- 如果规则标识符无效或不存在，命令将返回错误提示，并告知管理员无法找到相应的规则。
- 如果规则已经处于暂停状态，命令将返回相应的提示信息，告知管理员无需重复执行暂停操作。
- 如果在执行暂停操作时发生错误，命令将记录详细的错误信息，并显示在终端中，以便管理员进行排查和修复。

### 六、结论

`v-suspend-firewall-rule` 命令是一个用于精确控制防火墙规则状态的重要工具。通过正确使用该命令，管理员可以灵活地暂停特定的防火墙规则，以满足特定的网络流量需求或进行规则测试。请务必按照本文档中的说明进行操作，以确保网络安全和流量的有效管理。

## v-list-firewall-ipset

* [命令行Bash 脚本查看](https://hestiamb.org/bin/v-list-firewall-ipset)

`v-list-firewall-ipset` 是一个命令行工具，用于列出防火墙系统中配置的所有 IP 集（IPset）信息。这个工具允许管理员以不同的格式查看 IP 集列表，以便于进行审查、分析和管理。

### 使用方法

在终端中执行 `v-list-firewall-ipset` 命令，并根据需要指定输出格式。

#### 基本语法

```bash
v-list-firewall-ipset [FORMAT]
```

#### 选项（FORMAT）

- **json**：以 JSON 格式输出 IP 集列表。
- **plain**：以纯文本格式输出 IP 集列表，使用制表符分隔。
- **csv**：以 CSV 格式输出 IP 集列表，使用逗号分隔。
- **shell**：以易于阅读的表格格式输出 IP 集列表（默认格式）。

### 示例

1. 以 JSON 格式输出 IP 集列表：

```bash
v-list-firewall-ipset json
```

2. 以纯文本格式输出 IP 集列表：

```bash
v-list-firewall-ipset plain
```

3. 以 CSV 格式输出 IP 集列表：

```bash
v-list-firewall-ipset csv
```

4. 以表格格式输出 IP 集列表（默认）：

```bash
v-list-firewall-ipset
```

### 输出内容

输出内容将包含以下字段：

- **LISTNAME**：IP 集的名称。
- **IP_VERSION**：IP 地址的版本（如 IPv4 或 IPv6）。
- **AUTOUPDATE**：IP 集是否自动更新。
- **SUSPENDED**：IP 集是否已挂起。
- **SOURCE**：IP 集的来源（例如文件路径或外部源）。
- **TIME**：IP 集最后一次更新的时间戳。
- **DATE**：IP 集最后一次更新的日期。

具体输出格式将根据所选的格式选项而有所不同。

### 注意事项

- 在执行 `v-list-firewall-ipset` 命令之前，请确保您具备足够的权限和访问控制，以防止未经授权的查看或操作。
- 请确保防火墙系统已经正确配置，并且能够生成 IP 集列表。
- 如果 IP 集列表为空或无法获取，请检查防火墙系统的配置和状态，确保相关服务和组件已正确安装和配置。

### 错误处理

- 如果在执行命令时遇到错误，命令将返回相应的错误提示信息。请根据提示信息排查问题，并确保防火墙系统正常运行。
- 如果无法获取 IP 集列表或返回的结果不完整，请检查防火墙系统的配置和状态，确保 IP 集功能已启用，并且配置文件 `ipset.conf` 存在且可访问。

### 结论

`v-list-firewall-ipset` 命令是一个功能强大的工具，用于列出防火墙系统中配置的 IP 集信息。通过选择适当的输出格式，管理员可以方便地获取所需的数据，以便进行进一步的分析和管理。请按照本文档中的说明进行操作，以确保正确获取和使用 IP 集信息。

## v-list-firewall-ban

* [命令行Bash 脚本查看](https://hestiamb.org/bin/v-list-firewall-ban)

`v-list-firewall-ban` 是一个用于列出防火墙系统中所有被禁止（ban）的 IP 地址或 IP 地址范围的命令行工具。本文档旨在介绍该工具的使用方法、输出格式以及注意事项。

### 使用方法

在终端中执行 `v-list-firewall-ban` 命令，并根据需要指定输出格式。

#### 基本语法

```bash
v-list-firewall-ban [FORMAT]
```

#### 选项（FORMAT）

- **json**：以 JSON 格式输出被禁止的 IP 地址列表。
- **plain**：以纯文本格式输出被禁止的 IP 地址列表，使用制表符分隔。
- **csv**：以 CSV 格式输出被禁止的 IP 地址列表，使用逗号分隔。
- **shell**：以表格形式输出被禁止的 IP 地址列表（默认格式）。

### 示例

1. 以 JSON 格式输出被禁止的 IP 地址列表：

```bash
v-list-firewall-ban json
```

2. 以纯文本格式输出被禁止的 IP 地址列表：

```bash
v-list-firewall-ban plain
```

3. 以 CSV 格式输出被禁止的 IP 地址列表：

```bash
v-list-firewall-ban csv
```

4. 以默认表格格式输出被禁止的 IP 地址列表：

```bash
v-list-firewall-ban
```

### 输出内容

输出内容将包含以下字段：

- **IP**：被禁止的 IP 地址。
- **CHAIN**：与该 IP 地址相关的防火墙链（chain）。
- **TIME**：禁止该 IP 地址的时间戳。
- **DATE**：禁止该 IP 地址的日期。

具体输出格式将根据所选的格式选项而有所不同。

### 注意事项

- 在执行 `v-list-firewall-ban` 命令之前，请确保您具备足够的权限和访问控制，以防止未经授权的查看或操作。
- 请确保防火墙系统已经正确配置，并且能够生成被禁止 IP 地址的列表。
- 根据所选的输出格式，输出内容可能需要进行额外的处理或导入到其他工具中进行进一步分析。

### 错误处理

- 如果在执行命令时遇到错误，命令将返回相应的错误提示信息。请根据提示信息排查问题，并确保防火墙系统正常运行。
- 如果无法获取被禁止 IP 地址的列表或返回的结果不完整，请检查防火墙系统的配置和状态，确保相关服务和组件已正确安装和配置。

### 结论

`v-list-firewall-ban` 命令是一个功能强大的工具，用于列出防火墙系统中所有被禁止的 IP 地址。通过选择适当的输出格式，管理员可以方便地获取所需的数据，以便进行进一步的分析和管理。请按照本文档中的说明进行操作，以确保正确获取和使用被禁止 IP 地址的信息。

## v-list-firewall-rule

* [命令行Bash 脚本查看](https://hestiamb.org/bin/v-list-firewall-rule)

`v-list-firewall-rule` 是一个命令行工具，用于查看特定防火墙规则的详细信息。该工具允许管理员以不同的格式检索特定规则的动作、协议、端口、IP 地址等属性，以便于进行审查、分析和管理。

### 使用方法

在终端中执行 `v-list-firewall-rule` 命令，并指定要查询的规则ID和输出格式。

#### 基本语法

```bash
v-list-firewall-rule RULE_ID [FORMAT]
```

#### 参数

- **RULE_ID**：要查询的防火墙规则ID。
- **FORMAT**（可选）：输出格式，默认为 `shell`。可选项包括 `json`、`plain` 和 `csv`。

### 示例

1. 以默认格式（shell）输出规则ID为2的防火墙规则信息：

```bash
v-list-firewall-rule 2
```

2. 以JSON格式输出规则ID为2的防火墙规则信息：

```bash
v-list-firewall-rule 2 json
```

3. 以纯文本格式输出规则ID为2的防火墙规则信息：

```bash
v-list-firewall-rule 2 plain
```

4. 以CSV格式输出规则ID为2的防火墙规则信息：

```bash
v-list-firewall-rule 2 csv
```

### 输出内容

输出内容将包含以下字段：

- **ACTION**：防火墙规则的动作（如允许或拒绝）。
- **PROTOCOL**：使用的协议（如TCP或UDP）。
- **PORT**：规则应用于的端口号或端口范围。
- **IP**：与规则关联的IP地址或地址范围。
- **COMMENT**：规则的注释或描述。
- **SUSPENDED**：规则是否已挂起。
- **TIME**：规则最后一次更新的时间戳。
- **DATE**：规则最后一次更新的日期。

具体输出格式将根据所选的格式选项而有所不同。

### 注意事项

- 在执行 `v-list-firewall-rule` 命令之前，请确保您具备足够的权限和访问控制，以防止未经授权的查看或操作。
- 请确保防火墙系统已经正确配置，并且能够生成防火墙规则列表。
- 如果指定的规则ID不存在或无法获取规则信息，请检查防火墙系统的配置和状态，确保规则数据可访问且没有错误。

### 错误处理

- 如果在执行命令时遇到错误，命令将返回相应的错误提示信息。请根据提示信息排查问题，并确保防火墙系统正常运行。
- 如果无法获取特定规则的信息或返回的结果不完整，请检查防火墙系统的配置和状态，确保规则功能已启用，并且规则数据文件（如 `rules.conf`）存在且可访问。

### 结论

`v-list-firewall-rule` 命令是一个实用的工具，用于查看特定防火墙规则的详细信息。通过选择适当的输出格式，管理员可以方便地获取所需的数据，以便进行进一步的分析和管理。请按照本文档中的说明进行操作，以确保正确获取和使用防火墙规则信息。

## v-list-firewall

* [命令行Bash 脚本查看](https://hestiamb.org/bin/v-list-firewall)

`v-list-firewall` 是一个用于列出所有防火墙规则的命令行工具。通过执行此命令，管理员可以获取防火墙规则的详细信息，并以不同格式展示这些数据，以便于进一步分析和管理。

### 使用方法

在终端中执行 `v-list-firewall` 命令，并指定所需的输出格式。

#### 基本语法

```bash
v-list-firewall [FORMAT]
```

#### 参数

- **FORMAT**：输出格式，可选值为 `json`、`plain`、`csv` 或 `shell`。默认为 `shell` 格式。

### 示例

1. 以默认格式（shell）列出所有防火墙规则：

```bash
v-list-firewall
```

2. 以JSON格式列出所有防火墙规则：

```bash
v-list-firewall json
```

3. 以纯文本格式列出所有防火墙规则：

```bash
v-list-firewall plain
```

4. 以CSV格式列出所有防火墙规则：

```bash
v-list-firewall csv
```

### 输出内容

输出内容将包含防火墙规则的以下字段：

- **RULE**：防火墙规则的标识符。
- **ACTION**：防火墙规则的动作，例如允许（allow）或拒绝（deny）。
- **PROTOCOL**：规则适用的协议类型，如TCP或UDP。
- **PORT**：规则关联的端口号或端口范围。
- **IP**：规则适用的IP地址或地址范围。
- **COMMENT**：规则的注释或描述信息。
- **SUSPENDED**：规则是否已挂起。
- **TIME**：规则最后一次更新的时间戳。
- **DATE**：规则最后一次更新的日期。

具体输出格式将根据所选的格式选项而有所不同。

### 注意事项

- 在执行 `v-list-firewall` 命令之前，请确保您具备足够的权限和访问控制，以防止未经授权的查看或操作。
- 请确保防火墙系统已经正确配置，并且能够列出所有防火墙规则。
- 如果防火墙规则数据不存在或无法访问，请检查防火墙系统的配置和状态，确保规则数据文件可访问且没有错误。

### 错误处理

- 如果在执行命令时遇到错误，命令将返回相应的错误提示信息。请根据提示信息排查问题，并确保防火墙系统正常运行。
- 如果无法获取防火墙规则信息或返回的结果不完整，请检查防火墙系统的配置和状态，确保规则功能已启用，并且规则数据文件存在且可访问。

### 结论

`v-list-firewall` 命令是一个功能强大的工具，用于列出防火墙系统中的所有规则。通过选择适当的输出格式，管理员可以方便地获取所需的数据，以便进行进一步的分析和管理。请按照本文档中的说明进行操作，以确保正确获取和使用防火墙规则信息。
