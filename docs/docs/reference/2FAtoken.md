# 2FA令牌系列命令介绍

## v-add-user-2fa

* [命令行Bash 脚本查看](https://hestiamb.org/bin/v-add-user-2fa)

### 简介

`v-add-user-2fa`是Hestia系统中的一个CLI命令，用于为已存在的用户添加两步验证（2FA, Two-Factor Authentication）功能。通过该命令，管理员可以为指定的用户生成一个新的2FA令牌，并自动更新用户的配置信息。

### 使用方法

#### 命令格式

```bash
v-add-user-2fa <username>
```

其中`<username>`是你要为其启用2FA的用户的用户名。

#### 示例

1. **为`admin`用户启用2FA**

```bash
v-add-user-2fa admin
```

2. **为`john_doe`用户启用2FA**

```bash
v-add-user-2fa john_doe
```

### 配置步骤

1. **登录到服务器系统**

使用SSH或终端登录到你的服务器系统。

2. **运行`v-add-user-2fa`命令**

按照上述命令格式和示例，输入正确的用户名并运行以下命令。生成密钥

```bash
v-list-user admin json | jq -r '.[]|.TWOFA'
```

3. **检查输出**

命令执行后，你将看到类似于以下的输出信息：

```bash
XR4NRQLISPQQE2ZTADGSDGLJRWLOWKOTO
```

这些信息包含了用于配置2FA应用的恢复密钥（Secret Key）。

4. **配置2FA应用**

* 在web界面勾选 `启用双重验证` 保持后即可看见二维码。
* 打开你的2FA应用（如Google Authenticator、Authy等）。
* 根据应用的指导，手动输入秘密密钥或扫描二维码进行配置。
* 完成应用的配置过程。

5. **验证配置**

一旦在移动设备上设置了2FA应用，你可以尝试登录到需要2FA的应用或服务，以验证2FA是否已正确配置。在登录过程中，除了用户名和密码外，你还将被要求提供来自2FA应用的验证码。输入正确的验证码后，你应该能够成功登录。

### 注意事项

* 确保在运行命令之前备份任何重要数据。
* 验证用户名是否正确，并确保该用户存在于系统中。
* 如果用户已经启用了2FA，命令将输出错误并退出。
* 确保你的Hestia系统和相关组件已正确安装和配置。
* 遵循任何与2FA应用相关的安全最佳实践，以确保你的账户安全。

### 常见问题与解决方案

* **命令未找到**：确保你已经正确安装了Hestia系统，并且`v-add-user-2fa`命令在你的`PATH`中可用。
* **用户不存在**：检查输入的用户名是否正确，并确保该用户已存在于系统中。
* **2FA已启用**：如果尝试为已启用2FA的用户再次运行命令，将收到错误消息。在这种情况下，你可以跳过该用户或联系系统管理员以获取更多帮助。
* **配置问题**：如果你在配置2FA应用时遇到问题，请查阅该应用的官方文档或联系其支持团队以获取帮助。

## v-check-user-2fa

* [命令行Bash 脚本查看](https://hestiamb.org/bin/v-check-user-2fa)

### 简介

`v-check-user-2fa` 是 Hestia 系统中用于验证用户两步验证（2FA, Two-Factor Authentication）令牌的 CLI 命令。该命令在 Web 登录过程中使用，以确认用户提供的 2FA 令牌是否正确。

### 命令格式

```bash
v-check-user-2fa <username> <token>
```

- `<username>`：要进行 2FA 令牌验证的用户的用户名。
- `<token>`：用户提供的 2FA 令牌。

### 示例

#### 示例 1：验证 admin 用户的 2FA 令牌

```bash
v-check-user-2fa admin 493690
```

如果令牌验证成功，命令将正常退出，不输出任何内容。如果令牌验证失败或发生错误，将输出相应的错误消息。

### 使用指南

1. **确保 Hestia 系统已正确安装和配置**：在运行命令之前，请确保 Hestia 系统已正确安装并进行了必要的配置。

2. **检查用户名和令牌**：在运行命令之前，请确保提供的用户名和令牌是正确的。用户名必须是系统中已存在的用户，而令牌则应该是用户通过其他方式（如手机应用）生成的有效 2FA 令牌。

3. **执行命令**：在终端或 SSH 会话中执行 `v-check-user-2fa` 命令，并传入正确的用户名和令牌作为参数。

4. **检查结果**：观察命令的输出。如果命令没有输出任何内容并正常退出，则表示 2FA 令牌验证成功。如果输出包含错误消息，请根据错误消息进行相应的处理。

### 注意事项

- 请确保在运行命令时具有足够的权限。
- 请确保提供的用户名和令牌是有效的，并且与系统中存储的信息相匹配。
- 如果 Hestia 系统未启用 2FA，或者用户未启用 2FA，则无法验证 2FA 令牌。命令将输出相应的错误消息。

### 常见问题与解决方案

- **问题**：命令未找到。
  **解决方案**：请确保 Hestia CLI 工具已正确安装，并且命令的路径已包含在系统的 PATH 变量中。

- **问题**：用户名或令牌错误。
  **解决方案**：请检查提供的用户名和令牌是否正确。确保用户名是系统中已存在的用户，并且令牌是有效的 2FA 令牌。

- **问题**：2FA 未启用。
  **解决方案**：如果系统或用户未启用 2FA，则无法验证 2FA 令牌。请确保系统已启用 2FA，并且用户已启用其个人 2FA 设置。

- **问题**：其他未知错误。
  **解决方案**：查看命令输出的错误消息，并根据消息中的提示进行故障排除。如果问题仍然存在，请联系系统管理员或查看 Hestia 的官方文档以获取更多帮助。

### 日志记录

由于此命令主要用于实时验证用户的 2FA 令牌，通常不会在 Hestia 的日志中记录详细的验证事件。然而，如果令牌验证失败或发生其他错误，相关的错误消息将被记录到 Hestia 的日志文件中，以供管理员进行故障排查和监控。

## v-delete-user-2fa

* [命令行Bash 脚本查看](https://hestiamb.org/bin/v-delete-user-2fa)

### 简介

`v-delete-user-2fa` 是 Hestia 系统中用于删除用户两步验证（2FA, Two-Factor Authentication）设置的 CLI 命令。该命令接受一个参数：用户名，并删除该用户在系统中存储的 2FA 令牌和相关配置。

### 命令格式

```bash
v-delete-user-2fa <username>
```

- `<username>`：要删除 2FA 设置的用户的用户名。

### 示例

#### 示例 1：删除 admin 用户的 2FA 设置

```bash
v-delete-user-2fa admin
```

如果操作成功，命令将不会输出任何内容并正常退出。如果发生错误或验证失败，将输出相应的错误消息。

### 使用指南

1. **确保 Hestia 系统已正确安装和配置**：在运行命令之前，请确保 Hestia 系统已正确安装并进行了必要的配置。

2. **检查用户名**：在运行命令之前，请确保提供的用户名是正确的，并且该用户已存在。

3. **执行命令**：在终端或 SSH 会话中执行 `v-delete-user-2fa` 命令，并传入正确的用户名作为参数。

4. **检查结果**：观察命令的输出。如果命令没有输出任何内容并正常退出，则表示 2FA 设置已成功删除。如果输出包含错误消息，请根据错误消息进行相应的处理。

### 注意事项

- 请确保在运行命令时具有足够的权限。
- 请谨慎使用此命令，因为删除 2FA 设置将降低用户账户的安全性。
- 如果 Hestia 系统处于只读模式（demo mode），该命令将无法执行，并将输出相应的错误消息。

### 常见问题与解决方案

- **问题**：命令未找到。
  **解决方案**：请确保 Hestia CLI 工具已正确安装，并且命令的路径已包含在系统的 PATH 变量中。

- **问题**：用户名错误或用户不存在。
  **解决方案**：请检查提供的用户名是否正确，并确保该用户已存在于 Hestia 系统中。

- **问题**：2FA 未启用。
  **解决方案**：尽管 2FA 未启用，但此命令仍可用于删除不存在的 2FA 设置。然而，如果输出错误消息提示 2FA 未启用，那么您可能不需要执行此命令，因为用户本来就没有启用 2FA。

- **问题**：只读模式（demo mode）启用。
  **解决方案**：如果 Hestia 系统处于只读模式，您将无法执行此命令。请联系系统管理员以禁用只读模式或获取进一步帮助。

### 日志记录

当成功删除用户的 2FA 设置时，Hestia 系统将记录相关日志事件。这些日志事件将包含有关操作的信息，如执行操作的用户、操作类型以及操作的描述。这有助于管理员跟踪和监控系统中的更改。